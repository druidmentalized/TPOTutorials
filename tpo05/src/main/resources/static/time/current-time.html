<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Current time</title>
    <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
<div class="clock" id="clock">Loading from server...</div>

<div id="error-msg" class="error-message"></div>

<div class="triangle-container" id="triangle-container"></div>

<script>
    const container = document.getElementById("triangle-container");

    const edges = ["from-top", "from-bottom", "from-left", "from-right"];
    const sizes = ["small", "medium", "large"];
    const colors = ["green1", "green2", "green3", "green4", "green5"];

    function spawnTriangle() {
        const outer = document.createElement("div");
        outer.classList.add("triangle-outer");

        const randomEdge = edges[Math.floor(Math.random() * edges.length)];
        outer.classList.add(randomEdge);

        if (randomEdge === "from-top" || randomEdge === "from-bottom") {
            const leftPercent = Math.random() * 100;
            outer.style.left = `calc(${leftPercent}% - 30px)`;
        } else {
            const topPercent = Math.random() * 100;
            outer.style.top = `calc(${topPercent}% - 30px)`;
        }

        const rotation = Math.floor(Math.random() * 360);
        outer.style.transform = `rotate(${rotation}deg)`;

        const triangle = document.createElement("div");
        triangle.classList.add("triangle");

        const spinner = document.createElement("div");
        spinner.classList.add("spinner");

        spinner.appendChild(triangle);
        outer.appendChild(spinner);

        triangle.classList.add(sizes[Math.floor(Math.random() * sizes.length)]);
        triangle.classList.add(colors[Math.floor(Math.random() * colors.length)]);

        const layer = Math.floor(Math.random() * 3);
        outer.style.zIndex = `${layer}`;

        const duration = (10 + (2 - layer) * 5 + Math.random() * 3).toFixed(2);
        triangle.style.animationDuration = `${duration}s`;

        const delay = (Math.random() * 3).toFixed(2);
        triangle.style.animationDelay = `${delay}s`;

        container.appendChild(outer);

        setTimeout(() => {
            outer.remove();
        }, (parseFloat(duration) + parseFloat(delay)) * 1000 + 2000); // delay + duration + margin
    }

    setInterval(spawnTriangle, 200);
</script>
<script>
    const params = new URLSearchParams(window.location.search);
    const timezone = params.get("timezone");
    const format = params.get("format");

    let apiUrl = '/api/current-time';
    const query = [];

    if (timezone) query.push(`timezone=${encodeURIComponent(timezone)}`);
    if (format) query.push(`format=${encodeURIComponent(format)}`);

    if (query.length > 0) {
        apiUrl += '?' + query.join('&');
    }

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            const clockElement = document.getElementById("clock");
            const errorElement = document.getElementById("error-msg");

            if (data.time) {
                clockElement.textContent = data.time;
            }

            if (data.error) {
                errorElement.textContent = data.error;
                errorElement.classList.add("visible");

                setTimeout(() => {
                    errorElement.classList.remove("visible");
                }, 5000);
            }
        })
        .catch(error => {
            document.getElementById("clock").textContent = "Failed to load time: " + error;
        });
</script>
</body>
</html>